name: Build OpenClaw Apps

on:
  push:
    branches: [main]
    paths:
      - 'flutter_app/**'
      - 'scripts/fetch-proot-binaries.sh'
      - 'scripts/build-apk.sh'
      - '.github/workflows/flutter-build.yml'
  pull_request:
    branches: [main]
    paths:
      - 'flutter_app/**'
      - 'scripts/fetch-proot-binaries.sh'
      - 'scripts/build-apk.sh'
      - '.github/workflows/flutter-build.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build APK & AAB
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: stable
          cache: true

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('flutter_app/android/**/*.gradle*', 'flutter_app/android/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            flutter_app/.dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('flutter_app/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Setup signing
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > "${{ github.workspace }}/release.jks"
          cat > flutter_app/android/key.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=${{ github.workspace }}/release.jks
          EOF
          sed -i 's/^[[:space:]]*//' flutter_app/android/key.properties

      - name: Fetch PRoot binaries
        run: bash scripts/fetch-proot-binaries.sh

      - name: Verify PRoot binaries
        run: |
          echo "Checking jniLibs contents..."
          for abi in arm64-v8a armeabi-v7a x86_64; do
            for lib in libproot.so libprootloader.so; do
              FILE="flutter_app/android/app/src/main/jniLibs/${abi}/${lib}"
              if [ ! -f "$FILE" ]; then
                echo "ERROR: Missing $FILE"
                exit 1
              fi
              SIZE=$(stat -c%s "$FILE")
              if [ "$SIZE" -lt 1000 ]; then
                echo "WARN: $FILE looks like a placeholder (${SIZE} bytes)"
              else
                echo "OK: $FILE (${SIZE} bytes)"
              fi
            done
          done

      - name: Get Flutter dependencies
        working-directory: flutter_app
        run: flutter pub get

      - name: Analyze Dart code
        working-directory: flutter_app
        run: flutter analyze --no-fatal-infos
        continue-on-error: true

      - name: Build fat APK (all ABIs)
        working-directory: flutter_app
        run: flutter build apk --release

      - name: Build per-ABI APKs
        working-directory: flutter_app
        run: flutter build apk --release --split-per-abi

      - name: Build AAB (App Bundle)
        working-directory: flutter_app
        run: flutter build appbundle --release

      - name: Rename and collect artifacts
        id: apks
        run: |
          VERSION=$(grep '^version:' flutter_app/pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          mkdir -p artifacts

          # Fat APK
          cp flutter_app/build/app/outputs/flutter-apk/app-release.apk \
             "artifacts/OpenClaw-v${VERSION}-universal.apk"

          # Per-ABI APKs
          for abi in arm64-v8a armeabi-v7a x86_64; do
            SRC="flutter_app/build/app/outputs/flutter-apk/app-${abi}-release.apk"
            if [ -f "$SRC" ]; then
              cp "$SRC" "artifacts/OpenClaw-v${VERSION}-${abi}.apk"
            fi
          done

          # AAB
          AAB="flutter_app/build/app/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB" ]; then
            cp "$AAB" "artifacts/OpenClaw-v${VERSION}.aab"
          fi

          echo "Built artifacts:"
          ls -lh artifacts/

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-apks
          path: artifacts/*.apk
          retention-days: 30

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-aab
          path: artifacts/*.aab
          retention-days: 30

  build-node:
    name: Build OpenClaw Node APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Clone OpenClaw upstream
        run: |
          git clone --depth 1 https://github.com/openclaw/openclaw.git /tmp/openclaw

      - name: Copy Android app source
        run: |
          cp -r /tmp/openclaw/apps/android openclaw-node-android

      - name: Copy shared assets
        run: |
          # The app's build.gradle.kts references ../../shared/OpenClawKit/Sources/OpenClawKit/Resources
          mkdir -p openclaw-node-android/shared/OpenClawKit/Sources/OpenClawKit/Resources
          if [ -d /tmp/openclaw/shared/OpenClawKit/Sources/OpenClawKit/Resources ]; then
            cp -r /tmp/openclaw/shared/OpenClawKit/Sources/OpenClawKit/Resources/* \
              openclaw-node-android/shared/OpenClawKit/Sources/OpenClawKit/Resources/ 2>/dev/null || true
          fi

      - name: Fix assets path for standalone build
        working-directory: openclaw-node-android
        run: |
          # Rewrite assets.srcDir to point to the local shared dir instead of ../../shared
          sed -i 's|../../shared|shared|g' app/build.gradle.kts

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle (Node)
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-node-${{ runner.os }}-${{ hashFiles('openclaw-node-android/**/*.gradle*') }}
          restore-keys: gradle-node-${{ runner.os }}-

      - name: Make gradlew executable
        working-directory: openclaw-node-android
        run: chmod +x gradlew

      - name: Build debug APK
        working-directory: openclaw-node-android
        run: ./gradlew :app:assembleDebug

      - name: Build release APK
        working-directory: openclaw-node-android
        run: ./gradlew :app:assembleRelease

      - name: Collect Node artifacts
        id: node_artifacts
        run: |
          mkdir -p node-artifacts

          # Get version from build.gradle.kts
          VERSION=$(grep 'versionName' openclaw-node-android/app/build.gradle.kts | head -1 | grep -oP '"[^"]+"' | tr -d '"')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Debug APK
          DEBUG_APK=$(find openclaw-node-android/app/build/outputs/apk/debug -name "*.apk" | head -1)
          if [ -n "$DEBUG_APK" ]; then
            cp "$DEBUG_APK" "node-artifacts/OpenClawNode-v${VERSION}-debug.apk"
          fi

          # Release APK
          RELEASE_APK=$(find openclaw-node-android/app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -n "$RELEASE_APK" ]; then
            cp "$RELEASE_APK" "node-artifacts/OpenClawNode-v${VERSION}-release.apk"
          fi

          echo "Built Node artifacts:"
          ls -lh node-artifacts/

      - name: Upload Node artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-node-apks
          path: node-artifacts/*.apk
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: [build, build-node]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: openclaw-apks
          path: artifacts

      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: openclaw-aab
          path: artifacts

      - name: Download Node APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: openclaw-node-apks
          path: artifacts

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^version:' flutter_app/pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Check if this tag already exists
          if git ls-remote --tags origin "refs/tags/v${VERSION}" | grep -q .; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Release
        if: steps.version.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: OpenClaw v${{ steps.version.outputs.version }}
          body: |
            ## OpenClaw Android v${{ steps.version.outputs.version }}

            Standalone Android app — no Termux required.

            ### Downloads — OpenClaw Gateway
            | File | Description |
            |------|-------------|
            | `OpenClaw-v${{ steps.version.outputs.version }}-arm64-v8a.apk` | Most modern Android phones (recommended) |
            | `OpenClaw-v${{ steps.version.outputs.version }}-armeabi-v7a.apk` | Older 32-bit ARM devices |
            | `OpenClaw-v${{ steps.version.outputs.version }}-x86_64.apk` | Emulators / x86 devices |
            | `OpenClaw-v${{ steps.version.outputs.version }}-universal.apk` | All architectures (larger) |
            | `OpenClaw-v${{ steps.version.outputs.version }}.aab` | Android App Bundle (Play Store) |

            ### Downloads — OpenClaw Node
            | File | Description |
            |------|-------------|
            | `OpenClawNode-*-release.apk` | OpenClaw Node companion app (release) |
            | `OpenClawNode-*-debug.apk` | OpenClaw Node companion app (debug) |

            ### First Run
            1. Install the APK
            2. Follow the setup wizard (downloads ~500MB Ubuntu rootfs)
            3. Start the gateway from the dashboard
            4. Access the web dashboard at `http://127.0.0.1:18789`

            ### Requirements
            - Android 7.0+ (API 24)
            - ~500MB free storage for initial setup
            - Internet connection for first-time setup
          files: artifacts/*
          draft: false
          prerelease: false
